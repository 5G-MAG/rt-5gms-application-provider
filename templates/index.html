<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <div class="container">
  <div class="header">
    <img src="{{ url_for('static', filename='images/5gmag.png') }}" alt="5GMAG Logo" class="logo">
    <h1>M1 Client Tool</h1>
  </div>

  <div class="buttons">
    <button onclick="createNewSession()">Create Provisioning Session</button>
  </div>

  <table id="session_table">
    <thead>
      <tr>
        <th>Provisioning Session ID</th>
        <th>Remove Provisioning Session</th>
        <th>CHC from JSON</th>
        <th>Check the session details</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script>
  async function createNewSession() {
    const response = await fetch('/new_provisioning_session', { method: 'POST' });
    const data = await response.json();
    alert(data.message);
    let session_table = document.getElementById('session_table');
    let row = session_table.insertRow(-1);
    let cell1 = row.insertCell(0);
    let cell2 = row.insertCell(1);
    let cell3 = row.insertCell(2);
    let cell4 = row.insertCell(3);
    cell1.innerHTML = data.session_id;
    cell2.innerHTML = `<button onclick="deleteProvisioningSession('${data.session_id}')">Delete</button>`;
    cell3.innerHTML = `<button onclick="createChcFromJson('${data.session_id}')">Create CHC from JSON</button>`;
    cell4.innerHTML = `<button onclick="getProvisioningSessionDetails()">Check session details</button>`;
    
    // Add the new session id to the localStorage
    localStorage.setItem(data.session_id, true);
}
    
    async function deleteProvisioningSession(session_id) {
        const response = await fetch('/delete_provisioning_session_by_id', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 'prov-session-id': session_id })
        });

        const data = await response.json();
        alert(data.message);

        let session_table = document.getElementById('session_table');
        for(let i = 1; i < session_table.rows.length; i++){
          if(session_table.rows[i].cells[0].innerHTML === session_id){
            session_table.deleteRow(i);
          }
        }

        // Remove the deleted session id from the localStorage
        localStorage.removeItem(session_id);
    }

    async function createChcFromJson(session_id) {
      const response = await fetch('/create_chc_from_json', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          'prov-session-id': session_id})
        });
        const data = await response.json();
        alert(data.message);
      }


    async function getProvisioningSessionDetails() {
      const response = await fetch('/get_all_provisioning_sessions_details');
      const data = await response.json();
      // Open a new window and write the details to it
      let detailsWindow = window.open("", "_blank");
      detailsWindow.document.write("<pre>" + data.details + "</pre>");
    }


    // On page load, add all the session ids from sessionStorage to the table
    window.onload = function() {
      let session_table = document.getElementById('session_table');
      for (let i = 0; i < localStorage.length; i++) {
        let session_id = localStorage.key(i);
        let row = session_table.insertRow(-1);
        let cell1 = row.insertCell(0);
        let cell2 = row.insertCell(1);
        let cell3 = row.insertCell(2);
        let cell4 = row.insertCell(3);
        cell1.innerHTML = session_id;
        cell2.innerHTML = `<button onclick="deleteProvisioningSession('${session_id}')">Delete</button>`;
        cell3.innerHTML = `<button onclick="createChcFromJson('${session_id}')">Create CHC from JSON</button>`;
        cell4.innerHTML = `<button onclick="getProvisioningSessionDetails()">Check session details</button>`;
      }
    }
    </script>
  </div>  
  </body>
</html>
